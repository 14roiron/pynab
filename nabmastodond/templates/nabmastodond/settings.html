<div class="card" id="nabmastodond-settings">
  <div class="card-header">
    <h5 class="card-title">Mastodon</h5>
  </div>
  <div class="card-body">
    {% if config.access_token %}
      {% if config.username %}
        <div class="clearfix">
          <img width="80" height="80" src="{{ config.avatar }}" class="float-left rounded-circle mr-2"/>
          <div class="float-left ml-2">
            <h4>{% if config.display_name %}{{ config.display_name }}{% else %}{{ config.username }}{% endif %}</h4>
            <h5 class="text-muted"><a href="https://{{ config.instance }}/@{{ config.username }}" target="_blank" class="text-muted">{{ config.username }}@{{ config.instance }}</h5>
          </div>
        </div>
      {% else %}
        <p>Fetching account data...</p>
        <div class="progress">
          <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%"></div>
        </div>
      {% endif %}
      <script type="text/javascript">
      $(function() {
        $.ajax({
          url: "{% url 'nabmastodond.login' %}",
          method: "GET",
          success: function (data) {
            if (data.status == 'ok' && data.result == 'updated') {
              $.get("{{ request.get_full_path }}", function(data) {
                $("#nabmastodond-settings").replaceWith(data);
              });
            }
          },
          error: function (data) {
            if (data.status == 'error' && (data.result == 'unauthorized' || data.result == 'not_found')) {
              $.get("{{ request.get_full_path }}", function(data) {
                $("#nabmastodond-settings").replaceWith(data);
              });
            } else {
              var message = "An unknown error occurred fetching account data";
              if (data.message) {
                message = "An error occurred fetching account data: " + data.message;
              }
              $.bootstrapGrowl(message, {type: 'danger', allow_dismiss: true});
            }
          }
        });
      });
      </script>
    {% else %}
      <form action="/nabmastodond/connect">
        {% csrf_token %}
        <p>Not connected to mastodon.</p>
        <ol>
          <li>First, <strong>create an account for your Nabaztag</strong> on a given Mastodon instance, for example <a href="https://botsin.space/auth/sign_up" target="_blank">botsin.space</a>.
          <li>Connect this account with the "Connect" button. If your Nabaztag's account is on a different instance, change the value in the instance box below.</li>
        </ol>
        <div class="input-group input-group mb-3">
          <div class="input-group-prepend">
            <span class="input-group-text">Instance</span>
          </div>
          <input name="location" type="hidden" value="" />
          <input name="instance" type="text" class="form-control" placeholder="Mastodon instance" aria-label="Mastodon instance" value="{{ config.instance }}">
          <div class="input-group-append">
            <button type="submit" class="btn btn-primary">Connect</button>
          </div>
        </div>
      </form>
      <script type="text/javascript">
      $(function() {
        var form = $('#nabmastodond-settings form');
        var url = form.attr('action');
        form.on('submit', function() {
          form.find("input[name='location']").val(window.document.location);
          var formdata = form.serialize();
          form.find("button[type='submit']").addClass('disabled');
          form.find("button[type='submit']").html('Connecting...');
          $.ajax({
            url: url,
            method: "POST",
            data: formdata,
            success: function (data) {
              if (data.status == 'ok') {
                window.document.location = data.request_url;
              }
            },
            error: function (data) {
              form.find("button[type='submit']").removeClass('disabled');
              form.find("button[type='submit']").html('Connect');
              var message = "An unknown error occurred trying to connect with Mastodon";
              if (data.message) {
                message = "An error occurred trying to connect with Mastodon: " + data.message;
              }
              $.bootstrapGrowl(message, {type: 'danger', allow_dismiss: true});
            }
          });
          return false;
        });
      });
      </script>
    {% endif %}
  </div>
  <div class="card-footer">
    <div class="row mb-2">
      {% if config.access_token %}
      {% csrf_token %}
      <div class="modal fade disconnect-confirmation-modal" tabindex="-1" role="dialog" aria-labelledby="nabmastodond-disconnect-title" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="nabmastodon-disconnect-title">Disconnect from Mastodon?</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary" data-dismiss="modal">Cancel</button>
              <button type="button" class="btn btn-outline-danger disconnect-button">Disconnect</button>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12">
        <button type="button" class="btn btn-outline-danger ml-2 float-right" data-toggle="modal" data-target="#nabmastodond-settings .disconnect-confirmation-modal">Disconnect</button>
      </div>
      <script type="text/javascript">
      $(function() {
        var disconnectBtn = $('#nabmastodond-settings button.disconnect-button');
        disconnectBtn.on('click', function() {
          disconnectBtn.addClass('disabled');
          $.ajax({
            url: "{% url 'nabmastodond.connect' %}",
            beforeSend: function (xhr, settings) {
              xhr.setRequestHeader("X-CSRFToken", $('input[name="csrfmiddlewaretoken"]').val());
            },
            method: "DELETE",
            success: function (data) {
              $('.modal.disconnect-confirmation-modal').on('hidden.bs.modal', function (e) {
                $('.modal.disconnect-confirmation-modal').modal('dispose');
                $("#nabmastodond-settings").replaceWith(data);
              });
              $('.modal.disconnect-confirmation-modal').modal('hide');
            },
            error: function (data) {
              disconnectBtn.removeClass('disabled');
              $('.modal.disconnect-confirmation-modal').modal('hide');
              var message = "An unknown error occurred trying to disconnect";
              if (data.message) {
                message = "An error occurred trying to disconnect: " + data.message;
              }
              $.bootstrapGrowl(message, {type: 'danger', allow_dismiss: true});
            }
          })
          return false;
        });
      });
      </script>
      {% endif %}
    </div>
  </div>
</div>
